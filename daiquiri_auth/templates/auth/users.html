{% extends 'core/wide.html' %}
{% load staticfiles %}
{% load i18n %}
{% load core_tags %}
{% load ng_tags %}

{% block bodyargs %}ng-app="users" ng-controller="UsersController"{% endblock %}

{% block headextra %}

    <script type="text/javascript" src="{% static 'angular/angular.min.js' %}" ></script>
    <script type="text/javascript" src="{% static 'auth/js/users.js' %}" ></script>

{% endblock %}

{% block headline %}

    <h2>User management</h2>

{% endblock %}

{% block wide %}

{# User table #}

    <div class="row list-search">
        <form class="search-form col-sm-6 list-search-form" ng-submit="service.fetchProfiles()">
            <div class="input-group">
                <input class="form-control"
                       id="table-pager-search-input"
                       placeholder="{% trans 'Search entries' %}"
                       type="text" ng-model="service.data.search">
                <a href="" class="input-group-addon" ng-click="service.fetchProfiles()">
                    <span class="glyphicon glyphicon-search"></span>
                </a>
            </div>
        </form>

        <div class="col-sm-2 list-search-reset">
            <ul class="pagination">
                <li>
                    <a href="" ng-click="service.init()">{% trans 'Reset' %}</a>
                </li>
            </ul>
        </div>

        <div class="col-sm-4 list-search-count text-right">
            {$ service.data.count $} {% trans 'Entries found' %}
        </div>
    </div>

    <table class="table">
        <thead>
            <th>Name</th>
            <th>Username</th>
            <th>Email</th>
            <th>Information</th>
            <th></th>
        </thead>
        <tbody>
            <tr ng-repeat="profile in service.data.profiles">
                <td>{$ profile.full_name $}</td>
                <td>{$ profile.user.username $}</td>
                <td>{$ profile.user.email $}</td>
                <td>
                    <span ng-show="profile.user.is_superuser">Admin</span>
                    <span ng-hide="profile.user.is_active">Disabled</span>
                </td>
                <td class="text-right table-options">
                    <a href="" ng-click="service.showUserModal(profile.id)">
                        <span class="glyphicon glyphicon-eye-open"></span>
                    </a>
                    <a href="" ng-click="service.updateUserModal(profile.id)">
                        <span class="glyphicon glyphicon-pencil"></span>
                    </a>
                    <a href="" ng-click="service.toggleUserModal(profile.id)">
                        <span class="glyphicon glyphicon-remove-circle" ng-show="profile.user.is_active"></span>
                        <span class="glyphicon glyphicon-ok-circle" ng-hide="profile.user.is_active"></span>
                    </a>
{% if user.is_staff %}
                    {% internal_link '<strong>U</strong>' 'admin:auth_user_change' 'profile.id' ng_args='profile.id' target='_blank' %}
                    {% internal_link '<strong>P</strong>' 'admin:daiquiri_auth_profile_change' 'profile.id' ng_args='profile.id' target='_blank' %}
{% endif %}
                </td>
            </tr>
        </tbody>
    </table>

{# Show user modal #}

    <div class="modal" id="show-user-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="{% trans 'Close' %}">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title" id="update-user-modal-title">{$ service.data.profile.full_name $}</h4>
                </div>

                <div class="modal-body">

                    <dl>
                        <dt>{% trans 'Username' %}</dt>
                        <dd>{$ service.data.profile.user.username $}</dd>
                    </dl>
                    <dl>
                        <dt>{% trans 'Email' %}</dt>
                        <dd>{$ service.data.profile.user.email $}</dd>
                    </dl>

                    <div class="modal-seperator"></div>

                    <dl>
                        <dt>{% trans 'First name' %}</dt>
                        <dd>{$ service.data.profile.user.first_name $}</dd>
                    </dl>
                    <dl>
                        <dt>{% trans 'Last name' %}</dt>
                        <dd>{$ service.data.profile.user.last_name $}</dd>
                    </dl>

                    <div class="modal-seperator"></div>

{% for detail_key in detail_keys %}

                    <dl>
                        <dt>{{ detail_key.label }}</dt>
                        <dd>{$ service.data.profile.details['{{ detail_key.key }}'] $}</dd>
                    </dl>

{% endfor %}

                    <div ng-show="service.data.profile.attributes" class="modal-seperator"></div>

                    <dl ng-repeat="(detail_key, detail_value) in service.data.profile.attributes">
                        <dt>{$ detail_key $}</dt>
                        <dd>{$ detail_value $}</dd>
                    </dl>

                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">
                        {% trans 'Close' %}
                    </button>
                </div>
            </div>
        </div>
    </div>

{# Update user modal #}

    <div class="modal" id="update-user-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="{% trans 'Close' %}">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title" id="update-user-modal-title">{% trans 'Update user' %}</h4>
                </div>

                <div class="modal-body">
                    {% ng_form_field 'text' _('First name') 'first_name' 'service.data.profile.user.first_name' %}
                    {% ng_form_field 'text' _('Last name') 'last_name' 'service.data.profile.user.last_name' %}
                    {% ng_form_field 'text' _('Email') 'email' 'service.data.profile.user.email' %}

{% for detail_key in detail_keys %}

                    {% with 'service.data.profile.details.'|add:detail_key.key as ng_model %}
                    {% ng_form_field detail_key.data_type detail_key.label detail_key.key ng_model %}
                    {% endwith %}

{% endfor %}

                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">
                        {% trans 'Close' %}
                    </button>
                    <button type="button" class="btn btn-primary" ng-click="service.updateUser()">
                        {% trans 'Update user' %}
                    </button>
                </div>
            </div>
        </div>
    </div>

{# Toogle user modal #}

    <div class="modal" id="toggle-user-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="{% trans 'Close' %}">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title" id="toggle-user-modal-title">
                        <span ng-show="service.data.profile.user.is_active">{% trans 'Disable user' %}</span>
                        <span ng-hide="service.data.profile.user.is_active">{% trans 'Re-enable user' %}</span>
                    </h4>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">
                        {% trans 'Close' %}
                    </button>
                    <button type="button" class="btn btn-primary" ng-click="service.toggleUser()">
                        <span ng-show="service.data.profile.user.is_active">{% trans 'Disable user' %}</span>
                        <span ng-hide="service.data.profile.user.is_active">{% trans 'Re-enable user' %}</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}
