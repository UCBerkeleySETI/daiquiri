{% load i18n %}

<p>
    On this page, you can find an overview about a submitted query job. For a table view of the results, the plotting tool, and to access the download form, please use the tabs at the top of the page.
</p>

<div class="card mb-3" ng-show="service.job.query">
    <div class="card-header">
        {% trans 'Query' %}
    </div>
    <div class="card-body">
        <div class="cm-s-default" id="query">
            {$ service.job.query $}
        </div>
    </div>
    <div class="card-footer">
        <a href="" ng-click="service.forms.sql.copy_query(service.job.query_language, service.job.query)">
            {% trans 'Open new query form with this query' %}
        </a>
    </div>
</div>

<div class="card mb-3">
    <div class="card-header">
        {% trans 'Job parameters' %}
    </div>
    <div class="card-body">
        <dl class="query-overview">
            <dt>{% trans 'Job status' %}</dt>
            <dd ng-class="{
                          'text-success': service.job.phase == 'COMPLETED',
                          'text-warning': service.job.phase == 'TIMEOUT',
                          'text-danger': service.job.phase == 'ERROR',
                          'text-info': service.job.phase == 'QUEUED'}">
                {$ (service.phases|filter: {'id': service.job.phase})[0].text $}
            </dd>

            <dt ng-show="service.job.phase == 'ERROR'">{% trans 'Error' %}</dt>
            <dd ng-show="service.job.phase == 'ERROR'" class="text-danger">{$ service.job.error_summary $}</dd>

            <dt>{% trans 'Full database table name' %}</dt>
            <dd>{$ service.job.schema_name $}.{$ service.job.table_name $}</dd>

            <dt>{% trans 'Internal job id' %}</dt>
            <dd>{$ service.job.id $}</dd>

            <dt>{% trans 'Time submitted' %}</dt>
            <dd>{$ service.job.creation_time $}</dd>

            <dt ng-show="service.job.queue">{% trans 'Queue' %}</dt>
            <dd ng-show="service.job.queue">
                {$ (service.queues|filter: {'id': service.job.queue})[0].text $}
            </dd>

            <dt ng-show="service.job.start_time && service.job.creation_time">{% trans 'Time in queue' %}</dt>
            <dd ng-show="service.job.start_time && service.job.creation_time">{$ service.job.time_queue $} s</dd>

            <dt ng-show="service.job.end_time && service.job.start_time">{% trans 'Time for query' %}</dt>
            <dd ng-show="service.job.end_time && service.job.start_time">{$ service.job.time_query $} s</dd>

            <dt ng-show="service.job.nrows != null">{% trans 'Number of rows' %}</dt>
            <dd ng-show="service.job.nrows != null">{$ service.job.nrows $}</dd>

            <dt ng-show="service.job.size != null">{% trans 'Size of the table' %}</dt>
            <dd ng-show="service.job.size != null">{$ service.job.size | bytes $}</dd>

            <dt ng-show="service.job.sources.length">{% trans 'Source tables' %}</dt>
            <dd ng-show="service.job.sources.length" ng-repeat="source in service.job.sources">
                <a href="{$ source.url $}" target="blank">
                    {$ source.schema_name $}.{$ source.table_name $}
                </a>
            </dd>
        </dl>
    </div>
    <div class="card-footer">
        <div ng-show="service.job.phase == 'COMPLETED'">
            <a href="" ng-click="service.modal('update-job-modal')">
                {% trans 'Rename the result table or run id' %}
            </a>
        </div>
        <div ng-show="service.job.phase == 'EXECUTING' || service.job.phase == 'PENDING' || service.job.phase == 'QUEUED'">
            <a href="" ng-click="service.modal('abort-job-modal')">
                {% trans 'Abort the job' %}
            </a>
        </div>
        <div ng-hide="service.job.phase == 'EXECUTING' || service.job.phase == 'PENDING' || service.job.phase == 'QUEUED'">
            <a href="" ng-click="service.modal('archive-job-modal')">
                {% trans 'Archive the job' %}
            </a>
        </div>
    </div>
</div>

<div class="card mb-3" ng-show="service.job.native_query">
    <div class="card-header">
        {% trans 'Native query' %}
    </div>
    <div class="card-body">
        <div class="cm-s-default" id="native-query">
            {$ service.job.native_query $}
        </div>
    </div>
</div>

<div class="card mb-4" ng-show="service.job.actual_query">
    <div class="card-header">
        {% trans 'Actual query' %}
    </div>
    <div class="card-body">
        <div class="cm-s-default" id="actual-query">
            {$ service.job.actual_query $}
        </div>
    </div>
</div>
